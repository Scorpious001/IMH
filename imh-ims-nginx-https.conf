# Nginx configuration for IMH IMS with HTTPS support
# This is a template - Certbot will modify this automatically
# After SSL setup, Certbot will create the final configuration

# HTTP server - redirect to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name 3.234.249.243 ec2-3-234-249-243.compute-1.amazonaws.com;

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 3.234.249.243 ec2-3-234-249-243.compute-1.amazonaws.com;

    # SSL configuration (Certbot will add certificate paths)
    # ssl_certificate /etc/letsencrypt/live/your-domain/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 100M;
    proxy_read_timeout 300;
    proxy_connect_timeout 300;
    proxy_send_timeout 300;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Frontend static files (React app JS/CSS) - must come before Django static
    location /static/ {
        alias /home/ubuntu/SPS-IMH/frontend-build/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Serve React frontend
    location / {
        root /home/ubuntu/SPS-IMH/frontend-build;
        try_files $uri $uri/ /index.html;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # API endpoints - proxy to Django
    location /api/ {
        proxy_pass http://unix:/home/ubuntu/SPS-IMH/backend/imh-ims.sock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;  # Important for HTTPS detection
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Connection "";
        # Important: Preserve cookies
        proxy_cookie_path / /;
        proxy_cookie_domain off;
    }

    # Django admin static files (if needed)
    location /django-static/ {
        alias /home/ubuntu/SPS-IMH/backend/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Django media files
    location /media/ {
        alias /home/ubuntu/SPS-IMH/backend/media/;
        expires 7d;
        add_header Cache-Control "public";
    }
}
